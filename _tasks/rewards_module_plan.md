# Модуль наград: план, опорные промпты, чек-лист

## Цель
Выделить систему наград в независимый модуль, поддерживающий загрузку собственного конфига, генерацию и выдачу наград из любых частей приложения, с поддержкой диапазонов значений, перков и выбора игрока.

## Область изменений
- Конфиги:
  - Создать `assets/configs/adventure/rewards_config.json` для описания таблиц наград
  - Добавить поддержку загрузки конфига в `StaticData` и валидатор в `validators`
  - Обновить `encounters_config.json` (хранить ссылки на награды по id; при отсутствии — использовать tier)
  - Обновить `events_config.json` (в эффектах указывать tier или id награды)
- Код:
  - Новый модуль `js/state/rewards.js` (ядро выдачи)
  - Интеграция в UI: модалки для отображения наград, включая «выбери одно»
  - Модификация текущих мест выдачи наград (послебоевая награда и др.) для использования модуля
  - Поддержка модификаторов при расчёте наград

## Термины и структура

### RewardTable (сущность в конфиге наград)
- id: string
- tier: number
- tags: string[]
- mode: 'all' | 'select' — выдать все или предложить выбор одного варианта
- rewards: RewardSpec[] — перечень спецификаций наград

### RewardSpec
- type: 'currency' | 'unit' | 'perk'
- id: string — идентификатор валюты/юнита/перка
- amount: number | string — число (фикс) или строка диапазона вида '10-20'
- extra?: объект (для будущих расширений)

Примечания:
- Тип 'unit' соответствует текущему 'monster' (наименование унифицируем на уровне модуля, но поддержим обратную совместимость чтения)
- Тип 'perk' требует интеграции с подсистемой перков (идентификатор и тип перка)

## Валидатор конфига наград
- Проверить, что tables — массив
- Каждая таблица имеет id (строка), tier (число), tags (массив строк), mode ∈ {'all','pickOne'}
- rewards — массив, каждый объект имеет type ∈ {'currency','unit','perk'}, id (строка), amount (число ≥0) или amount (строка формата 'min-max' с min≤max)

## API модуля `Rewards`
Глобально: `window.Rewards`

- init(): Promise<void>
  - Загружает активный конфиг `rewards` из `StaticData`
- grantById(rewardId: string, opts?): Promise<void>
  - Находит таблицу по id, генерирует награды, применяет модификаторы, показывает модалку (если требуется), распределяет награды в подсистемы
- grantByTier(tier: number, opts?): Promise<void>
  - Выбирает случайную таблицу с подходящим tier (и при необходимости по тегам), далее как выше
- generate(table: RewardTable, opts?): RewardItem[] | { pick: RewardItem[] }
  - Строит финальный список к выдаче; если mode='pickOne' — возвращает набор вариантов для выбора
- applyModifiers(items: RewardItem[], context): RewardItem[]
  - Применяет модификаторы (множители валют, бонусные шансы и т.п.)
- distribute(items: RewardItem[]): void
  - Раскладывает: currency → `adventureState.currencies`, unit → `adventureState.pool`, perk → подсистема перков
- showModal(items | pick): Promise<RewardItem[]>
  - Показывает модалку «Награды» или «Выбери одно», возвращает выбранные/подтверждённые элементы

Примечание: модуль не держит UI-маркап в коде — использует шаблоны `fragments/templates.html`.

## UI
- Новый шаблон модалки выбора награды: `tpl-modal-reward-pick` с заголовком «Выбери одно»
- Список наград рендерится карточками: валюта/юнит/перк; использовать существующие шаблоны и добавить `tpl-reward-perk`
- Кнопка подтверждения активна только при выборе одного элемента

## Интеграции
- После боя (`finishBattleToAdventure`) заменить прямую выдачу на `Rewards.grantById`/`grantByTier` согласно данным энкаунтера
- Узлы типа reward в приключении — активируют `Rewards.grantByTier` или `grantById`
- События: эффекты превращаются в вызовы модуля (tier или id)

## Миграции конфигов
- `encounters_config.json`:
  - Поле `rewards` заменить на `rewardId?: string`
  - Если `rewardId` пусто — при победе использовать `tier`
- `events_config.json`:
  - В эффектах добавить объекты вида `{ type: 'rewardById', id: '...' }` или `{ type: 'rewardByTier', tier: 2 }`

## Опорные промпты (для быстрых проверок)
- «Сгенерируй 1000 наград по tier=2 и посчитай среднее золото»
- «Проверь, что модификатор валюты x1.2 применился к золоту»
- «Покажи модалку выбора и верни выбранный элемент»
- «Валидируй rewards_config.json с некорректным amountRange»

## Чек-лист
- [x] Создан файл `assets/configs/adventure/rewards_config.json` (базовый пример)
- [x] Добавлен валидатор `validateRewardsConfig` в `js/io/validators.js`
- [x] Конфиг `rewards` подключён в `js/state/staticData.js`
- [x] Реализован модуль `js/state/rewards.js` (init, generate, applyModifiers, distribute, grantById, grantByTier)
- [x] Добавлены шаблоны `tpl-reward-perk`, `tpl-modal-reward-pick` в `fragments/templates.html`
- [x] Интеграция в `js/ui/ui.js` (замена прямой выдачи в конце боя на модуль)
- [x] Переделаны энкаунтеры: `rewardId` вместо детальных списков; поведение при пустом `rewardId` → tier
- [x] Переделаны эвенты: эффекты на `rewardById`/`rewardByTier`
- [x] Поддержаны модификаторы в выдаче
- [x] Обновлена документация в `docs/configs.md` и `docs/ui-toolkit.md`

## Замечания по совместимости
- На переходный период `Rewards` поддержит чтение старого поля `rewards` у энкаунтера, но будет логировать предупреждение с рекомендацией миграции.

# Дорожная карта и чеклист по реорганизации UI

Цель: перевести UI на слоистую архитектуру и снизить дублирование разметки с помощью шаблонов и ленивой подгрузки фрагментов, не внедряя сборщики и крупные фреймворки.

Слои UI:
- App Shell: корневые контейнеры, глобальные кнопки/индикаторы, точки монтирования (`screen-layer`, `modal-layer`, `toast-layer`, `tooltip-layer`).
- Screens: взаимоисключающие экраны гейм‑стейтов (intro, adventure, fight-setup, battle, bestiary, settings, rules).
- Sub-views: виджеты внутри экрана (вкладки/панели у adventure и battle).
- Modals/Overlays: блокирующие окна со стеком и фокус‑менеджментом.
- Tooltips/Toasts: подсказки и уведомления без блокировки.

Ниже — этапы работ. У каждой задачи есть краткая цель, критерии готовности и «промпт исполнителю» — его можно вставлять в ИИ‑ассистент или описание задачи.

---

## Этап 0. Подготовка инфраструктуры

1) Добавить корневые контейнеры слоёв в `index.html`
- Цель: единые точки монтирования для экранов/модалок/уведомлений/тултипов.
- Критерии готовности:
  - Есть контейнеры `#screen-layer`, `#modal-layer`, `#toast-layer`, `#tooltip-layer` (пока пустые или совместимые с текущей версткой).
  - Текущие экраны продолжают работать как раньше.
- Промпт исполнителю:
```
Добавь в index.html контейнеры для слоёв: screen-layer, modal-layer, toast-layer, tooltip-layer внутри корневого блока. Не ломай текущие экраны; по умолчанию screen-layer может оставаться пустым, так как экраны пока живут в DOM.
```

2) Ввести карту z-index и базовые классы
- Цель: предсказуемое перекрытие слоёв.
- Критерии готовности:
  - В `css/base.css` есть переменные или константы z-index: tooltip(1000), modal(900), toast(800), overlay(700), screens(100), shell(0).
- Промпт:
```
Добавь в css/base.css переменные или корневые классы для z-index слоёв: tooltip=1000, modal=900, toast=800, overlay=700, screens=100, shell=0. Применяй их к новым контейнерам.
```

---

## Этап 1. UI Toolkit на чистом JS (template + фрагменты)

3) Добавить `js/uiToolkit.js`
- Цель: унифицированные функции: ensureScreenLoaded(url), mountTemplate(id), cloneTemplate(id).
- Критерии:
  - Файл подключён до `js/ui.js`.
  - `UI.ensureScreenLoaded(id,url)` умеет подгружать HTML‑фрагменты и переносить найденные `<template>` в `document.body`.
- Промпт:
```
Создай js/uiToolkit.js с API: UI.ensureScreenLoaded(id,url), UI.mountTemplate(id,container,opts), UI.cloneTemplate(id). Подключи его в index.html до js/ui.js.
```

4) Базовые templates
- Цель: кирпичики для повторяющихся блоков.
- Критерии:
  - Внизу index.html добавлены <template> для: меню‑бар, шапка таблицы юнитов, группа кнопок, блок «загрузка файла».
- Промпт:
```
Добавь в конец index.html набор <template>: tpl-menu-bar, tpl-unit-table-head, tpl-button-row, tpl-file-input. Пока их не используем, просто подключи.
```

---

## Этап 2. Перенос экранов на фрагменты (ленивая подгрузка)

5) Экран «Правила»
- Цель: вынести в `fragments/rules.html`, загрузка через UI.ensureScreenLoaded.
- Критерии:
  - В index.html отсутствует блок #rules-screen.
  - showRules сначала грузит фрагмент, потом заполняет Markdown как сейчас.
- Промпт:
```
Вырежи #rules-screen из index.html в fragments/rules.html. Обнови showRules() так, чтобы перед showScreen('rules-screen') вызывался UI.ensureScreenLoaded('rules-screen','fragments/rules.html').
```

6) Экран «Бестиарий»
- Цель: аналогично вынести `#bestiary-screen` в `fragments/bestiary.html`.
- Критерии: экран работает, загрузка конфига/таблица рендерится как прежде.
- Промпт:
```
Перенеси #bestiary-screen в fragments/bestiary.html и обнови входную точку (showBestiary/backToIntroFromBestiary), чтобы перед переключением экрана выполнялась UI.ensureScreenLoaded('bestiary-screen','fragments/bestiary.html').
```

7) Экран «Настройки»
- Цель: вынести `#settings-screen` в `fragments/settings.html`.
- Критерии: инициализация настроек на показе экрана не сломана.
- Промпт:
```
Перенеси #settings-screen в fragments/settings.html. В showSettings() добавь await UI.ensureScreenLoaded(...). Убедись, что displaySettings() вызывается после загрузки фрагмента.
```

8) Экраны Adventure: setup/main/result
- Цель: вынести три экрана в соответствующие фрагменты.
- Критерии: весь текущий функционал adventure сохраняется.
- Промпт:
```
Перенеси #adventure-setup-screen, #adventure-screen, #adventure-result-screen в fragments/*.html. Обнови showAdventureSetup/showAdventure/showAdventureResult, чтобы сначала грузить фрагменты через UI.ensureScreenLoaded.
```

9) Экраны боя: fight-setup и battle
- Цель: вынести `#fight-screen` и `#battle-screen` в фрагменты.
- Критерии: старт боя из обоих режимов работает; кнопки/лог — как прежде.
- Промпт:
```
Перенеси #fight-screen и #battle-screen в fragments/*.html. Обнови showFight/showBattle/startBattle/proceedStartBattle — перед показом экрана грузить фрагмент.
```

---

## Этап 3. Замена дублирующихся блоков на templates

10) Меню‑бар
- Цель: использовать tpl-menu-bar вместо дубликатов.
- Критерии: все экраны используют один и тот же темплейт меню.
- Промпт:
```
Заменяй статические блоки «menu-bar» на монтирование UI.mountTemplate('tpl-menu-bar', target, { slots:{backLabel:'Главная'}, handlers:{back:showIntro} }).
```

11) Шапки таблиц и карточки юнитов
- Цель: унифицировать шапки и ячейки иконок.
- Критерии: bestiary/adventure таблицы используют общий темплейт.
- Промпт:
```
Внедри tpl-unit-table-head и используйте его при генерации таблиц в adventure.js и bestiary.js. Минимизируй ручную разметку thead в JS‑строках.
```

12) Компонент «Загрузка файла»
- Цель: единый вид и поведение в fight/adventure/bestiary.
- Критерии: все экраны используют один темплейт с параметрами label/id/accept.
- Промпт:
```
Создай tpl-file-input с label, кастомной кнопкой и input[type=file]. Применяй его в экранах конфигураций, прокидывая id и обработчики через opts.handlers.
```

---

## Этап 4. Модалки

13) Базовый модальный менеджер
- Цель: стек модалок, фокус‑трап, закрытие по Esc/клику вне.
- Критерии: API `UI.showModal(content, opts)`, `UI.confirm(message)`, `UI.alert(message)`.
- Промпт:
```
Реализуй модальный менеджер: контейнер в #modal-layer, стек окон, aria‑атрибуты, возврат фокуса после закрытия. Предоставь UI.showModal/UI.confirm/UI.alert.
```

14) Интеграция подтверждений
- Цель: заменить window.confirm на UI.confirm в risk‑операциях.
- Критерии: все подтверждения унифицированы.
- Промпт:
```
Найди confirm/alert в JS и замени на UI.confirm/UI.alert. Добавь неблокирующие версии с промисами.
```

---

## Этап 5. Toast и Tooltip

15) Toast‑уведомления
- Цель: UI.showToast(type, message, timeout).
- Критерии: success/error/info стили, очередь/автозакрытие.
- Промпт:
```
Добавь в UI.showToast(type,message,timeout) менеджер уведомлений с рендером в #toast-layer. Используй для статусов загрузки/сохранения.
```

16) Tooltip
- Цель: унифицированный тултип, позиционирование относительно курсора.
- Критерии: задержка появления, авто‑скрытие, не конфликтует с модалками.
- Промпт:
```
Реализуй UI.attachTooltip(el, content|fn, opts). Для юнитов в бою — использовать новый тултип или адаптировать текущую панель как закрепляемый тултип.
```

---

## Этап 6. Роутер и стейт‑машина

17) Централизованный роутер
- Цель: единая точка переключения экранов и саб‑вью.
- Критерии: `AppState.screen` + `AppState.subscreen`, события через eventBus.
- Промпт:
```
Добавь простой роутер: setScreen(name, params), setSubscreen(name, params). Переведи showIntro/showFight/showBattle/etc. на обращения к роутеру, который подгружает фрагменты через UI.ensureScreenLoaded и вызывает showScreen().
```

18) Саб‑вью у «Приключения»
- Цель: вкладки «Карта/Таверна/Магазин/Армия».
- Критерии: переключение без перезагрузки экрана, общий state.
- Промпт:
```
Добавь в adventure саб‑вью: карта, таверна, магазин, армия. Реализуй навигацию вкладками и отрисовку через templates. Данные берутся из adventureState.
```

---

## Этап 7. A11y, клавиатура, локализация, темы, звук

19) Доступность и клавиши
- Цель: Tab‑навигация, Esc закрывает модалку, Enter подтверждает.
- Критерии: aria‑ролями и фокус‑ловушки в модалках, role=tablist для вкладок.
- Промпт:
```
Добавь фокус‑менеджмент в модалки и aria‑атрибуты. Введи глобальные шорткаты: Esc (закрыть верхнюю модалку), ←→ (переключать вкладки), Enter (основное действие).
```

20) Локализация
- Цель: словарь строк + функция t(key, params).
- Критерии: вынести пользовательские строки экранов в словарь ru.json, протянуть t().
- Промпт:
```
Добавь простую i18n: assets/i18n/ru.json и функцию t(key,vars). Заменяй хардкоды в UI на t(). Пока используем только ru.
```

21) Темы и звук
- Цель: light/dark тема и базовые UI‑звуки с мастер‑мьютом.
- Критерии: переключатель темы в настройках, аудио‑хэндлер кликов/ошибок/награды.
- Промпт:
```
Добавь CSS‑переключатель темы (data-theme) и сохранение выбора. Введи UI.play(type) с Audios для click/success/error/reward и мастер‑мьютом.
```

---

## Этап 8. Производительность

22) Прелоадеры/скелетоны
- Цель: пока грузятся фрагменты/данные — показывать скелеты.
- Критерии: для «Правила», «Бестиарий», «Приключение».
- Промпт:
```
Добавь skeleton‑блоки и показывай их во время UI.ensureScreenLoaded и загрузки данных.
```

23) Виртуализация таблиц
- Цель: не рендерить тысячи строк сразу.
- Критерии: bestiary и большие списки — виртуализированы (простая ленивка без зависимостей).
- Промпт:
```
Реализуй простую виртуализацию для длинных таблиц: окно видимости + буфер, пересчёт при скролле.
```

24) Ограничение шума в логах боя
- Цель: уменьшить DOM‑операции.
- Критерии: батчирование добавлений и ограничение длины лога.
- Промпт:
```
Сделай addToLog батчируемым (requestAnimationFrame) и ограничь число элементов в DOM до N с удалением старых.
```

---

## Общий чеклист (отмечать по мере выполнения)

- [ ] Этап 0.1: Контейнеры слоёв в index.html
- [ ] Этап 0.2: Карта z-index в CSS
- [ ] Этап 1.1: uiToolkit.js подключён и работает
- [ ] Этап 1.2: Базовые templates добавлены
- [ ] Этап 2.1: Rules → fragments
- [ ] Этап 2.2: Bestiary → fragments
- [ ] Этап 2.3: Settings → fragments
- [ ] Этап 2.4: Adventure setup/main/result → fragments
- [ ] Этап 2.5: Fight setup/Battle → fragments
- [ ] Этап 3.1: Меню‑бар через template
- [ ] Этап 3.2: Шапки таблиц/карточки юнитов через template
- [ ] Этап 3.3: Компонент загрузки файла внедрён в экраны
- [ ] Этап 4.1: Модальный менеджер
- [ ] Этап 4.2: Замена confirm/alert
- [ ] Этап 5.1: Toast‑уведомления
- [ ] Этап 5.2: Tooltip‑система
- [ ] Этап 6.1: Роутер/централизация showScreen
- [ ] Этап 6.2: Саб‑вью у adventure
- [ ] Этап 7.1: A11y и шорткаты
- [ ] Этап 7.2: Локализация (ru)
- [ ] Этап 7.3: Темы и звук
- [ ] Этап 8.1: Прелоадеры/скелетоны
- [ ] Этап 8.2: Виртуализация таблиц
- [ ] Этап 8.3: Батчирование лога боя

---

## Как пользоваться промптами
- Для каждой задачи возьми соответствующий «Промпт исполнителю», вставь его в описание задачи/чат ассистента и выполни изменения.
- После каждого шага проверь «Критерии готовности» и отметь пункт в чеклисте выше.

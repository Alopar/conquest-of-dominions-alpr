# Рефакторинг системы конфигов и экран «Конфигурация»

Ниже — список задач с критериями приёмки и промптами. Выполняем по одной; прогресс отмечаем в чек-листе в конце файла.

## Базовые конфиги
- `monsters_config.json` — типы юнитов, визуалы
- `battle_config.json` → переименовать в `battle_setup.json` — сетап боя для экрана «Схватка»
- `adventure_config.json` — сценарий приключения

Папку примеров `assets/configs/samples/` удалить.

---

## 1) Ввести слой «Статические данные» (Static Data Layer)
- **Цель**: единая точка доступа к базовым конфигам и пользовательским переопределениям; инициализация при старте приложения.
- **Артефакты**: `js/state/staticData.js`
- **API**:
  - `StaticData.init()` — загрузка базовых конфигов
  - `StaticData.getConfigList()` — список конфигов: `{ id, title, hasUser, useUser }[]`
  - `StaticData.getConfig(id)` — активная версия (user/base)
  - `StaticData.setUserConfig(id, json)` — сохранить пользовательский конфиг (LocalStorage)
  - `StaticData.setUseUser(id, boolean)` — флаг «использовать пользовательский» (LocalStorage)
  - `StaticData.refresh()` — перечитать всё по текущим флагам
- **LocalStorage**:
  - `userConfig:{id}` — JSON пользователя
  - `configPrefs` — `{ [id]: { useUser: boolean } }`
- **Критерии**:
  - Инициализация без участия экранов
  - Переключение user/base мгновенно влияет на `getConfig(id)`
- **Промпт**:
  Создай `js/state/staticData.js` с указанным API. Загружай `monsters_config.json`, `battle_setup.json` (временно читать `battle_config.json` до переименования), `adventure_config.json`. Экспортируй в `window.StaticData`.

---

## 2) Добавить кнопку «Конфигурация» на главном экране
- **Артефакты**: `fragments/intro.html`, роутер/показ экранов
- **Критерии**: кнопка есть, ведёт на экран «Конфигурация»
- **Промпт**:
  Добавь кнопку «Конфигурация» в `fragments/intro.html` и обработчик показа экрана `config`.

---

## 3) Новый экран «Конфигурация»
- **Артефакты**: `fragments/config.html`, `js/configScreen.js`
- **Требования**: контейнер под таблицу, кнопка «Назад», кнопка «Обновить конфигурацию игры»
- **Критерии**: экран открывается, элементы присутствуют
- **Промпт**:
  Создай фрагмент и модуль экрана; подключи показ через существующий роутер/функции.

---

## 4) Таблица управления конфигами на экране «Конфигурация»
- **Колонки**: ID / Название / Индикатор «есть пользовательский» / Чекбокс «Использовать пользовательский» / Кнопка «Загрузить» / Кнопка «Скачать»
- **Поведение**:
  - Данные таблицы из `StaticData.getConfigList()`
  - Чекбокс дергает `StaticData.setUseUser(id, val)` и перерисовывает строку
  - «Загрузить» — взять БАЗОВЫЙ конфиг из ассетов и применить его (без примеров)
  - «Скачать» — отдать активный JSON (если включён useUser — пользовательский; иначе базовый)
- **Критерии**: все действия без перезагрузки, состояние сохраняется в LocalStorage
- **Промпт**:
  Реализуй `js/configScreen.js`: рендер таблицы, чекбоксы, «Загрузить» (подтянуть базовый из `assets/configs` и применить через StaticData), «Скачать» (Blob активного JSON).

---

## 5) Кнопка «Обновить конфигурацию игры»

---

## 6) Game Settings: вынести в отдельную логику (не часть системы конфигов)
- **Артефакты**: `js/state/gameSettings.js`
- **Требования**:
  - `game_settings.json` не относится к конфигам экрана «Конфигурация» и не отображается в его таблице
  - Загружается отдельным модулем при инициализации приложения из `assets/configs/game_settings.json`
  - Предоставляет API: `GameSettings.init()`, `GameSettings.get()`, `GameSettings.refresh()`
  - Экспорт в `window.GameSettings`
- **Критерии**:
  - Ни один экран не загружает `game_settings` через StaticData или экраны конфигурации
  - Экраны получают настройки только через `GameSettings.get()`
- **Промпт**:
  Создай модуль `js/state/gameSettings.js`, реализуй загрузку `assets/configs/game_settings.json` на старте и методы доступа. Замените прямые обращения к `game_settings.json` в коде на использование `window.GameSettings`.
- **Поведение**: вызывает `StaticData.refresh()` и уведомляет части приложения (EventBus/прямые вызовы)
- **Критерии**: экраны начинают использовать актуальные данные из StaticData
- **Промпт**:
  Добавь обработчик кнопки: `StaticData.refresh()` + событие через `window.EventBus` (если есть) или вызовы синхронизации UI.

---

## 7) Удалить конфиги-примеры
- **Действия**: удалить `assets/configs/samples/*`, убрать кнопки скачивания образцов
- **Критерии**: нет папки примеров, UI не предлагает образцы
- **Промпт**:
  Удали папку и связанные вызовы `downloadSample*` из кода.

---

## 8) Убрать прямую загрузку конфигов из «Бестиария» и «Приключения»
- **Действия**: заменить прямые `fetch` на `StaticData.getConfig(id)`
- **Критерии**: оба экрана берут данные только из StaticData
- **Промпт**:
  Найди места прямых загрузок (`monsters_config.json`, `adventure_config.json`) и переведи на StaticData.

---

## 9) Пользовательские конфиги в LocalStorage
- **Критерии**: после перезапуска пользовательские конфиги и флаги сохраняются
- **Промпт**:
  Убедись, что `StaticData.setUserConfig` и `StaticData.setUseUser` персистят и восстанавливаются в `init()`.

---

## 10) Хранение настроек экрана «Конфигурация»
- **Критерии**: чекбоксы отражают состояние `configPrefs` после перезапуска
- **Промпт**:
  Рендер таблицы использует только `StaticData.getConfigList()`.

---

## 11) Переименовать battle_config → battle_setup
- **Действия**: файл `assets/configs/battle_config.json` переименовать в `assets/configs/battle_setup.json`; обновить обращения; временная обратная совместимость
- **Критерии**: экран «Схватка» работает
- **Промпт**:
  Обнови StaticData и валидаторы, сначала поддержи оба имени, затем полностью перейди на новое.

---

## 12) «Battle Setup» на экране «Схватка»
- **Действия**: выделить логику загрузки сетапа боя для «Схватки»; экран читает активный сетап из `StaticData.getConfig('battleSetup')`, но позволяет загрузить локальный файл поверх (опционально без сохранения в StaticData)
- **Критерии**: локальная загрузка работает, общая система не ломается
- **Промпт**:
  Вынеси текущее `initBattleConfig` в отдельный блок для «Схватки», чтобы принимать данные либо из StaticData, либо из локального файла.

---

## 13) Обновить валидаторы
- **Действия**: привести `js/io/validators.js` к новым id и схемам; добавить `validateMonstersConfig`, `validateBattleSetup`, `validateAdventureConfig`, `validateGameSettings`
- **Критерии**: понятные ошибки валидации
- **Промпт**:
  Обнови и экспортируй валидаторы через `window.*`.

---

## 14) Интеграция по проекту
- **Действия**: в `js/adventure.js`, `js/bestiary.js`, `js/config.js`, возможно `js/game.js` — перейти на StaticData; удалить неиспользуемые загрузчики
- **Критерии**: проект работает, данные из одного места
- **Промпт**:
  Найди прямые `fetch('assets/configs/...')` и замени на `StaticData`.

---

Примечания:
- «Загрузить» = взять базовый конфиг из ассетов и применить; «Скачать» = скачать активный JSON (user/base).
- Примеры конфигов удаляются, «образцов» больше нет.

---

## Чек-лист выполнения
- [ ] 1) Ввести слой «Статические данные»
- [ ] 2) Кнопка «Конфигурация» на главном экране
- [ ] 3) Экран «Конфигурация»
- [ ] 4) Таблица управления конфигами
- [ ] 5) Кнопка «Обновить конфигурацию игры»
- [ ] 6) Вынести `game_settings` в отдельную логику
- [ ] 7) Удалить конфиги-примеры
- [ ] 8) Убрать прямую загрузку конфигов из «Бестиария» и «Приключения»
- [ ] 9) Пользовательские конфиги в LocalStorage
- [ ] 10) Хранение настроек экрана «Конфигурация»
- [ ] 11) Переименовать battle_config → battle_setup
- [ ] 12) «Battle Setup» на экране «Схватка»
- [ ] 13) Обновить валидаторы
- [ ] 14) Интеграция по проекту
